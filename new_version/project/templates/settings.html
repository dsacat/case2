{% extends 'layout.html' %}
{% block content %}
<section class="settings-layout anim-fade-in anim-delay-2">
    <form class="panel settings-panel" method="POST" enctype="multipart/form-data" action="">
        <input type="hidden" name="action" value="save_settings">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <h1>Настройки проекта</h1>
        <div class="settings-sections">
            <article class="settings-section">
                <h3>Основное</h3>
                <div class="field-grid">
                    <div class="field {% if field_errors.site_name %}field-error{% endif %}">
                        <label>Название сайта</label>
                        <input class="input-styled" type="text" name="site_name" value="{{ form_data.site_name | default(settings_data.site_name) }}" required>
                    </div>
                    <div class="field {% if field_errors.school_name %}field-error{% endif %}">
                        <label>Школа (родительный падеж)</label>
                        <input class="input-styled" type="text" name="school_name" value="{{ form_data.school_name | default(settings_data.school_name) }}" required>
                    </div>
                </div>
                <div class="field">
                    <label>Контакты footer</label>
                    <textarea class="input-styled" name="contacts_raw" placeholder="Лево|Центр|Право&#10;Лево 2|Центр 2|Право 2">{{ settings_data.contacts_raw }}</textarea>
                    <p class="hint-line">Формат: одна строка = одна строка footer, колонки разделяются символом |</p>
                </div>
                <div class="field">
                    <label>Объявление для всех пользователей</label>
                    <textarea class="input-styled" name="announcement" maxlength="500" placeholder="Оставьте пустым, чтобы скрыть баннер">{{ settings_data.announcement }}</textarea>
                    <p class="hint-line">Отображается на всех страницах сайта. Макс. 500 символов.</p>
                </div>
                <div class="field">
                    <label>Тип баннера</label>
                    <select class="input-styled" name="announcement_type">
                        <option value="info" {% if settings_data.announcement_type == 'info' %}selected{% endif %}>Информация (синий)</option>
                        <option value="warning" {% if settings_data.announcement_type == 'warning' %}selected{% endif %}>Предупреждение (жёлтый)</option>
                        <option value="error" {% if settings_data.announcement_type == 'error' %}selected{% endif %}>Ошибка (красный)</option>
                    </select>
                </div>
            </article>

            <article class="settings-section">
                <h3>Баланс и пополнение</h3>
                <div class="field-grid">
                    <div class="field">
                        <label>Порог низкого баланса, руб</label>
                        <input class="input-styled" type="number" min="0" max="100000" name="low_balance_threshold" value="{{ settings_data.low_balance_threshold }}">
                        <p class="hint-line">Баланс ниже этого значения подсвечивается в шапке. 0 = отключено.</p>
                    </div>
                    <div class="field">
                        <label>Максимальная сумма пополнения, руб</label>
                        <input class="input-styled" type="number" min="1" max="1000000" name="topup_max_amount" value="{{ settings_data.topup_max_amount }}">
                        <p class="hint-line">Максимальная сумма одного пополнения для пользователя.</p>
                    </div>
                </div>
            </article>

            <article class="settings-section">
                <h3>Сеть и защита</h3>
                <div class="field-grid four">
                    <div class="field">
                        <label>Host</label>
                        <input class="input-styled" type="text" name="host" value="{{ settings_data.host }}" required>
                    </div>
                    <div class="field">
                        <label>Port</label>
                        <input class="input-styled" type="number" min="1" max="65535" name="port" value="{{ settings_data.port }}" required>
                    </div>
                    <div class="field">
                        <label>Protection</label>
                        <input class="input-styled" type="number" min="24" max="512" name="protection" value="{{ settings_data.protection }}" required>
                    </div>
                    <div class="field field-checkbox-block">
                        <label>Debug</label>
                        <label class="checkbox-line"><input type="checkbox" name="debug" {% if settings_data.debug %}checked{% endif %}><span>Включено</span></label>
                    </div>
                </div>
            </article>

            <article class="settings-section">
                <h3>Почта (SMTP)</h3>
                <div class="field-grid four">
                    <div class="field field-checkbox-block">
                        <label>Включить отправку email</label>
                        <label class="checkbox-line">
                            <input type="checkbox" name="mail_enabled" {% if settings_data.mail_enabled %}checked{% endif %}>
                            <span>Включено</span>
                        </label>
                    </div>
                    <div class="field">
                        <label>SMTP сервер</label>
                        <input class="input-styled" type="text" name="mail_server" value="{{ settings_data.mail_server }}">
                    </div>
                    <div class="field">
                        <label>SMTP порт</label>
                        <input class="input-styled" type="number" min="1" max="65535" name="mail_port" value="{{ settings_data.mail_port }}">
                    </div>
                    <div class="field field-checkbox-block">
                        <label>TLS</label>
                        <label class="checkbox-line">
                            <input type="checkbox" name="mail_use_tls" {% if settings_data.mail_use_tls %}checked{% endif %}>
                            <span>Использовать TLS</span>
                        </label>
                    </div>
                </div>
                <div class="field-grid">
                    <div class="field">
                        <label>Email отправителя (логин SMTP)</label>
                        <input class="input-styled" type="email" name="mail_username" value="{{ settings_data.mail_username }}">
                    </div>
                    <div class="field">
                        <label>SMTP пароль</label>
                        <input class="input-styled" type="password" name="mail_password" placeholder="Оставьте пустым, чтобы не менять">
                        {% if settings_data.mail_password_mask %}
                        <p class="hint-line">Текущий пароль: {{ settings_data.mail_password_mask }}</p>
                        {% endif %}
                    </div>
                </div>
            </article>

            <article class="settings-section">
                <h3>Иконка</h3>
                <div class="field">
                    <label>Иконка сайта (любой формат, сохраняется как AVIF + ICO 16x16)</label>
                    <input class="input-styled" type="file" name="site_icon" accept="image/*">
                    <p class="hint-line">Текущая: {{ settings_data.ico_path }}</p>
                </div>
            </article>

            <article class="settings-section">
                <h3>Фон</h3>
                <div class="field">
                    <label>Фон сайта (единый для обеих тем, в тёмной теме затемняется автоматически)</label>
                    <input class="input-styled" type="file" name="site_bg" accept="image/*">
                    <p class="hint-line">Текущий: {{ settings_data.bg_path }}</p>
                </div>
                <div class="field-inline">
                    <label>Blur</label>
                    <input class="input-styled" type="number" min="0" max="25" name="bg_blur" value="{{ settings_data.bg_blur }}">
                </div>
            </article>
        </div>
        <button class="btn btn-primary" type="submit">Сохранить настройки</button>
    </form>
</section>

<section class="panel anim-fade-in anim-delay-3">
    <h2>Управление ролями</h2>
    <div class="table-wrap">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Пользователь</th>
                <th>Текущая роль</th>
                <th>Новая роль</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for row in role_users %}
            <tr>
                <td>{{ row.id }}</td>
                <td>{{ row.email }}</td>
                <td>{{ row.surname }} {{ row.name }}</td>
                <td>{{ role_label(row.role) }}</td>
                <td>
                    {% if assignable_roles and row.role != 'super_admin' and (User.role == 'super_admin' or row.role not in ['admin', 'super_admin']) %}
                    <form class="inline-actions" method="POST" action="">
                        <input type="hidden" name="action" value="set_role">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="target_user_id" value="{{ row.id }}">
                        <select class="input-styled" name="new_role">
                            {% for role in assignable_roles %}
                            {% if can_change_user_role(User, row, role) %}
                            <option value="{{ role }}" {% if row.role == role %}selected{% endif %}>{{ role_label(role) }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary btn-sm" type="submit">Применить</button>
                    </form>
                    {% else %}
                    <span>-</span>
                    {% endif %}
                </td>
                <td>
                    {% if row.id == User.id %}
                    <span>Текущий аккаунт</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6">Пользователи не найдены.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
